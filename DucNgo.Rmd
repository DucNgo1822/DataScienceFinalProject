---
title: "R Notebook"
output: html_notebook
---
```{r}
library(tidyverse)     # for data cleaning and plotting
library(lubridate)     # for date manipulation
library(openintro)     # for the abbr2state() function
library(gplots)        # for col2hex() function
library(RColorBrewer)  # for color palettes
library(ggthemes)      # for more themes (including theme_map())
library(plotly)        # for the ggplotly() - basic interactivity
library(gganimate)     # for adding animation layers to ggplots
library(transformr)    # for "tweening" (gganimate)
library(gifski)        # need the library for creating gifs but don't need to load each time
library(shiny)         # for creating interactive apps
library(lubridate)     # for date manipulation
library(ggthemes)      # for even more plotting themes
library(janitor)  
theme_set(theme_minimal())
```

```{r}
AAPL <- read_csv("AAPL.csv")
AAPL <- AAPL%>% 
  select(-Open, -High, -Low, -`Adj Close`) %>% 
  mutate(Sector = "Technology",
         Company = "AAPL") %>% 
  mutate(return = (Close - 75.0875)/ 75.0875 * 100) %>% 
  mutate(shares = 17001802000) %>% 
  mutate(market_cap = shares * Close) 

HON <- read_csv("HON.csv")
HON <- HON %>% 
  select(-Open, -High, -Low, -`Adj Close`) %>% 
  mutate(Sector = "Industrials",
         Company = "HON") %>% 
  mutate(return = (Close - 180.79)/ 180.79 * 100) %>% 
  mutate(shares  = 784122288) %>% 
  mutate(market_cap = shares * Close) 

UNP <- read_csv("UNP.csv")
UNP <- UNP %>% 
  select(-Open, -High, -Low, -`Adj Close`) %>% 
  mutate(Sector = "Industrials",
         Company = "UNP") %>% 
  mutate(return = (Close - 182.27)/ 182.27 * 100)  %>% 
  mutate(shares  = 784122288) %>% 
  mutate(market_cap = shares * Close) 

UPS <- read_csv("UPS.csv")
UPS <- UPS %>% 
  select(-Open, -High, -Low, -`Adj Close`) %>% 
  mutate(Sector = "Industrials",
         Company = "UPS") %>% 
  mutate(return = (Close - 116.79)/ 116.79 * 100) %>% 
  mutate(shares  = 173362905) %>% 
  mutate(market_cap = shares * Close) 

JNJ <- read_csv("JNJ.csv")
JNJ <- JNJ %>% 
  select(-Open, -High, -Low, -`Adj Close`) %>% 
  mutate(Sector = "Health care",
         Company = "JNJ") %>% 
  mutate(return = (Close - 145.97)/ 145.97 * 100) %>% 
  mutate(shares  = 2663138579) %>% 
  mutate(market_cap = shares * Close) 
  
UNH <- read_csv("UNH.csv")
UNH <- UNH %>% 
  select(-Open, -High, -Low, -`Adj Close`) %>% 
  mutate(Sector = "Health care",
         Company = "UNH") %>% 
  mutate(return = (Close - 292.50)/ 292.50 * 100) %>% 
  mutate(shares  = 945319404) %>% 
  mutate(market_cap = shares * Close)

RHHBY<- read_csv("RHHBY.csv")
RHHBY <- RHHBY %>% 
  select(-Open, -High, -Low, -`Adj Close`) %>% 
  mutate(Sector = "Health care",
         Company = "RHHBY") %>% 
  mutate(return = (Close - 40.89)/ 40.89 * 100) %>% 
  mutate(shares = 160000000) %>% 
  mutate(market_cap = shares * Close)
    
  

MSFT<- read_csv("MSFT.csv")
MSFT <- MSFT %>% 
  select(-Open, -High, -Low, -`Adj Close`) %>% 
  mutate(Sector = "Technology",
         Company = "MSFT") %>% 
  mutate(return = (Close - 160.62	)/ 160.62	 * 100) %>% 
  mutate(shares = 7635409400) %>% 
  mutate(market_cap = shares * Close)
  


NVDA<- read_csv("NVDA.csv")
NVDA <- NVDA %>% 
  select(-Open, -High, -Low, -`Adj Close`) %>% 
  mutate(Sector = "Technology",
         Company = "NVDA") %>% 
  mutate(return = (Close - 239.91)/ 239.91 * 100) %>% 
  mutate(shares = 620000000) %>% 
  mutate(market_cap = shares * Close)
  


GOOGL<- read_csv("GOOGL.csv")
GOOGL <- GOOGL %>% 
  select(-Open, -High, -Low, -`Adj Close`) %>% 
  mutate(Sector = "Communication Services",
         Company = "GOOGL") %>% 
  mutate(return = (Close - 1368.68	)/ 1368.68	 * 100) %>% 
  mutate(shares = 299360029) %>% 
  mutate(market_cap = shares * Close)
  

TCEHY<- read_csv("TCEHY.csv")
TCEHY <- TCEHY %>% 
  select(-Open, -High, -Low, -`Adj Close`) %>% 
  mutate(Sector = "Communication Services",
         Company = "TCEHY") %>% 
  mutate(return = (Close - 49.88)/ 49.88 * 100) %>% 
  mutate(shares = 70787668) %>% 
  mutate(market_cap = shares * Close)
  

FB<- read_csv("FB.csv")
FB <- FB %>% 
  select(-Open, -High, -Low, -`Adj Close`) %>% 
  mutate(Sector = "Communication Services",
         Company = "FB") %>% 
  mutate(return = (Close - 209.78)/ 209.78 * 100) %>% 
  mutate(shares = 2405448410) %>% 
  mutate(market_cap = shares * Close)
   

NEE<- read_csv("NEE.csv")
NEE <- NEE %>% 
  select(-Open, -High, -Low, -`Adj Close`) %>% 
  mutate(Sector = "Utilities",
         Company = "NEE") %>% 
  mutate(return = (Close - 59.6550)/ 59.6550 * 100) %>% 
  mutate(shares = 488965893) %>% 
  mutate(market_cap = shares * Close)
  
  

ENLAY<- read_csv("ENLAY.csv")
ENLAY <- ENLAY %>% 
  select(-Open, -High, -Low, -`Adj Close`) %>% 
  mutate(Sector = "Utilities",
         Company = "ENLAY") %>% 
  mutate(return = (Close - 8.05)/ 8.05 * 100)  %>% 
  mutate(shares = 6176196279) %>% 
  mutate(market_cap = shares * Close)
  


IBDSF<- read_csv("IBDSF.csv")
IBDSF <- IBDSF %>% 
  select(-Open, -High, -Low, -`Adj Close`) %>% 
  mutate(Sector = "Utilities",
         Company = "IBDSF") %>% 
  mutate(return = (Close - 10.23)/ 10.23 * 100) %>%
  mutate(shares = 6362000000) %>% 
  mutate(market_cap = shares * Close)
  
  

BRKA<- read_csv("BRK-A.csv")
BRKA <- BRKA %>% 
  select(-Open, -High, -Low, -`Adj Close`) %>% 
  mutate(Sector = "Financials",
         Company = "BRKA") %>% 
  mutate(return = (Close - 342261)/ 342261 * 100) %>% 
  mutate(shares = 1336348609 ) %>% 
  mutate(market_cap = shares * Close)
  

JPM<- read_csv("JPM.csv")
JPM <- JPM %>% 
  select(-Open, -High, -Low, -`Adj Close`) %>% 
  mutate(Sector = "Financials",
         Company = "JPM") %>% 
  mutate(return = (Close - 141.09)/ 141.09 * 100) %>% 
  mutate(shares = 3084000000) %>% 
  mutate(market_cap = shares * Close)
  

V<- read_csv("V.csv")
V <- V %>% 
  select(-Open, -High, -Low, -`Adj Close`) %>% 
  mutate(Sector = "Financials",
         Company = "V") %>% 
  mutate(return = (Close - 191.12)/ 191.12 * 100)  %>% 
  mutate(shares = 1696113603) %>% 
  mutate(market_cap = shares * Close)
  

AMZN<- read_csv("AMZN.csv")
AMZN <- AMZN %>% 
  select(-Open, -High, -Low, -`Adj Close`) %>% 
  mutate(Sector = "Communication Discretionary",
         Company = "AMZN") %>% 
  mutate(return = (Close - 1898.01)/ 1898.01 * 100) %>% 
  mutate(shares = 503564743) %>% 
  mutate(market_cap = shares * Close)
  

TSLA<- read_csv("TSLA.csv")
TSLA <- TSLA %>% 
  select(-Open, -High, -Low, -`Adj Close`) %>% 
  mutate(Sector = "Communication Discretionary",
         Company = "TSLA") %>% 
  mutate(return = (Close - 86.052)/ 86.052 * 100) %>% 
  mutate(shares = 181341586) %>% 
  mutate(market_cap = shares * Close)
  


BABA<- read_csv("BABA.csv")
BABA <- BABA %>% 
  select(-Open, -High, -Low, -`Adj Close`) %>% 
  mutate(Sector = "Communication Discretionary",
         Company = "BABA") %>% 
  mutate(return = (Close - 219.77	)/ 219.77	 * 100) %>% 
  mutate(shares = 21688948800) %>% 
  mutate(market_cap = shares * Close)
  


WMT<- read_csv("WMT.csv")
WMT <- WMT %>% 
  select(-Open, -High, -Low, -`Adj Close`) %>% 
  mutate(Sector = "Consumer Staples",
         Company = "WMT") %>% 
  mutate(return = (Close - 118.94)/ 118.94 * 100) %>% 
  mutate(shares = 2869684230) %>% 
  mutate(market_cap = shares * Close)
  

NSRGF<- read_csv("NSRGF.csv")
NSRGF <- NSRGF %>% 
  select(-Open, -High, -Low, -`Adj Close`) %>% 
  mutate(Sector = "Consumer Staples",
         Company = "NSRGF") %>% 
  mutate(return = (Close - 108.06	)/ 108.06	 * 100) %>% 
  mutate(shares = 2929000000) %>% 
  mutate(market_cap = shares * Close)
  

PG<- read_csv("PG.csv")
PG <- PG %>% 
  select(-Open, -High, -Low, -`Adj Close`) %>% 
  mutate(Sector = "Consumer Staples",
         Company = "PG") %>% 
  mutate(return = (Close - 123.41	)/ 123.41	 * 100) %>% 
  mutate(shares = 2502259668) %>% 
  mutate(market_cap = shares * Close)
  
SPY<- read_csv("SPY.csv")
SPY <- SPY %>% 
  select(-Open, -High, -Low, -`Adj Close`) %>% 
  mutate(Sector = "All field",
         Company = "SPY") %>% 
  mutate(return = (Close - 324.87	)/ 324.87	 * 100) %>% 
  mutate(shares = 13012450) %>% 
  mutate(market_cap = shares * Close)
```


```{r}
XOM <- read_csv("XOM.csv")
XOM <- XOM %>%
  select(-Open, -High, -Low, -`Adj Close`) %>% 
  mutate(Sector="Energy",
         Company= "XOM") %>% 
   mutate(return = (Close - 70.90)/ 70.90 * 100) %>% 
  mutate(shares = 434167944) %>% 
  mutate(market_cap = shares * Close)



CVX <- read_csv("CVX.csv")
CVX <- CVX %>%
  select(-Open, -High, -Low, -`Adj Close`) %>%
  mutate(Sector="Energy",
         Company= "CVX") %>%
   mutate(return = (Close - 121.43)/ 121.43 * 100) %>% 
  mutate(shares = 197023923) %>% 
  mutate(market_cap = shares * Close)
  

RDS_A <-read_csv("RDS-A.csv")
RDS_A <- RDS_A %>%
  select(-Open, -High, -Low, -`Adj Close`) %>%
  mutate(Sector="Energy",
         Company= "RDS_A")%>%
   mutate(return = (Close - 59.74)/ 59.74 * 100) %>% 
  mutate(shares = 8058300000) %>% 
  mutate(market_cap = shares * Close)
  

energy <- rbind(XOM,CVX,RDS_A)
```

```{r}
AMT <- read_csv("AMT.csv")
AMT <- AMT %>%
  select(-Open, -High, -Low, -`Adj Close`) %>%
  mutate(Sector="Real Estate",
         Company= "AMT")%>%
  mutate(return = (Close - 228.50)/ 228.50 * 100) %>% 
  mutate(shares = 46014457) %>% 
  mutate(market_cap = shares * Close)
  
KE <- read_csv("KE.csv")
KE <- KE %>%
  select(-Open, -High, -Low, -`Adj Close`) %>%
  mutate(Sector="Real Estate",
         Company= "KE")%>%
  mutate(return = (Close - 17.690)/ 17.690 * 100) %>% 
  mutate(shares = 2492397900) %>% 
  mutate(market_cap = shares * Close)
  

PLD <- read_csv("PLD.csv")
PLD <- PLD %>%
  select(-Open, -High, -Low, -`Adj Close`) %>%
  mutate(Sector="Real Estate",
         Company= "PLD")%>%
  mutate(return = (Close - 88.40	)/ 88.40 * 100) %>% 
  mutate(shares = 739500000) %>% 
  mutate(market_cap = shares * Close)
 
real_estate <- rbind(AMT,KE,PLD)
```

```{r}
BHP <-read_csv("BHP.csv")
BHP <- BHP%>%
  select(-Open, -High, -Low, -`Adj Close`) %>%
  mutate(Sector="Material",
         Company= "RDS_A") %>%
  mutate(return = (Close - 54.92)/ 54.92 * 100) %>% 
  mutate(shares = 248421053) %>% 
  mutate(market_cap = shares * Close)
  
LIN <-read_csv("LIN.csv")
LIN <- LIN %>%
  select(-Open, -High, -Low, -`Adj Close`) %>%
  mutate(Sector="Material",
         Company= "LIN") %>%
  mutate(return = (Close - 210.74)/ 210.74 * 100) %>% 
  mutate(shares = 52915292) %>% 
  mutate(market_cap = shares * Close)

RIO <-read_csv("RIO.csv")
RIO <- RIO %>%
  select(-Open, -High, -Low, -`Adj Close`) %>%
  mutate(Sector="Material",
         Company= "RIO")%>%
  mutate(return = (Close - 59.89)/ 59.89 * 100) %>% 
  mutate(shares = 170077427) %>% 
  mutate(market_cap = shares * Close)
  
material <- rbind(BHP,LIN,RIO)
```


```{r}
communication_services <- rbind(GOOGL, TCEHY, FB)
utilities <- rbind(NEE, ENLAY, IBDSF)
financials <- rbind(JPM, BRKA, V)
communication_discretionary <- rbind(AMZN, TSLA, BABA)
consumer_staple <- rbind(WMT, NSRGF, PG)
```

```{r}
tech <- rbind(AAPL,MSFT,NVDA)
industrials <- rbind(HON,UNP,UPS)
health <- rbind(JNJ,UNH,RHHBY)
```

```{r}
sp <- rbind(communication_services, utilities, financials, communication_discretionary, consumer_staple,
            tech, industrials, health, real_estate, material, energy, SPY)
```


```{r, eval=FALSE}
tech %>% 
  ggplot(aes(y = Close, x = Date, color = Company)) +
  geom_line()+
  geom_text(aes(label = Company))+
  labs(subtitle = "Date:{frame_along}")+
  transition_reveal(Date)+
  theme(legend.position = 0)
```

```{r, eval=FALSE}
anim_save("tech.gif")
```

```{r}
knitr::include_graphics("tech.gif")
```


```{r, eval = FALSE}
health %>% 
  ggplot(aes(y = Close, x = Date, color = Company)) +
  geom_line()+
  geom_text(aes(label = Company))+
  labs(subtitle = "Date:{frame_along}")+
  transition_reveal(Date)+
  theme(legend.position = 0)
```

```{r, eval=FALSE}
anim_save("health.gif")
```

```{r}
knitr::include_graphics("health.gif")
```

```{r, eval = FALSE}
industrials %>% 
  ggplot(aes(y = Close, x = Date, color = Company)) +
  geom_line()+
  geom_text(aes(label = Company))+
  labs(subtitle = "Date:{frame_along}")+
  transition_reveal(Date)+
  theme(legend.position = 0)
```

```{r, eval = FALSE}
anim_save("industrials.gif")
```

```{r}
knitr::include_graphics("industrials.gif")
```

```{r}
sp %>% 
  group_by(Sector,Company) %>% 
  filter(Sector == "Technology") %>% 
  ggplot(aes(x = Date, y = return, color = Company))+
  geom_line()
```


```{r}
sp %>% 
  filter(Sector == "Industrials") %>% 
  ggplot(aes(x = Date, y = return, color = Company))+
  geom_line()
```

```{r}
sp %>% 
  filter(Sector == "Health care") %>% 
  ggplot(aes(x = Date, y = return, color = Company))+
  geom_line()
```

```{r}
sp %>% 
  filter(Sector == "Communication Services") %>% 
  ggplot(aes(x = Date, y = return, color = Company))+
  geom_line()
```

```{r}
sp %>% 
  filter(Sector == "Utilities") %>% 
  ggplot(aes(x = Date, y = return, color = Company))+
  geom_line()
```

```{r}
sp %>% 
  filter(Sector == "Financials") %>% 
  ggplot(aes(x = Date, y = return, color = Company))+
  geom_line()
```

```{r}
sp %>% 
  filter(Sector == "All field") %>% 
  ggplot(aes(x = Date, y = return, color = Company))+
  geom_line()
```

```{r, fig.width= 10, fig.height= 4}
return_type <- sp %>% 
  filter(Sector!="All field") %>% 
  select(-Close, -Volume) %>% 
  group_by(Date, Sector) %>% 
  mutate(avg_return = mean(return),
         type_return = ifelse(avg_return<0, "negative", "positive"))%>% 
  ungroup() %>% 
  group_by(Sector) %>% 
  mutate(`Proportion negative` = mean(type_return == "negative"),
         `Proportion positive` = mean(type_return == "positive")) %>% 
  pivot_longer(cols = `Proportion negative`:`Proportion positive`,
               names_to = "prop_type",
               values_to = "prop") %>% 
  summarize(Sector, prop_type, prop) %>%
  distinct(Sector, prop_type, prop)


return_type %>% 
  ggplot(aes(x = prop, y = prop_type, fill = prop_type )) + 
  geom_col()+
  geom_text(aes(label = round(prop,digits = 2)), size = 2)+
  facet_wrap(~Sector)+
  labs(title = "Proportions of negative and positive daily average returns per sector",
       fill = "Type of return",
       x = "", 
       y = "")+
  theme(legend.position = 0,
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y=element_blank())
  
```

```{r, eval = FALSE}
sp %>% 
  filter(Sector!="All field") %>% 
  select(-Close, -return) %>%
  group_by(Sector) %>% 
  mutate(cum_vol = cumsum(Volume)) %>% 
  ggplot(aes(x = cum_vol, y = Sector, fill = Sector))+
  geom_col()+
  labs(title = "Total amount of transactions per sector last year",
       subtitle = "Date:{closest_state}",
       y = "",
       x = "")+
  theme(legend.position = 0,
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y =element_blank())+
  transition_states(Date)
    
```


```{r, eval = FALSE}
anim_save("transactions.gif")
```

```{r}
knitr::include_graphics("transactions.gif")
```

